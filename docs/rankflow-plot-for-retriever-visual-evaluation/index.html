
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="color-scheme" content="light dark"/>
    <script>
      (function() {
        var theme = localStorage.getItem('theme-preference');
        if (theme === 'dark' || theme === 'light') {
          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"/>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap"
              rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/stylesheet/style.css">


    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/pygments/github.min.css">


    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/solid.css">

    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">

        <link rel="stylesheet" type="text/css"
              href="https://www.safjan.com/styles/custom.css">

        <link href="https://www.safjan.com/feeds/all.atom.xml?utm_source=rss&utm_medium=feed&utm_campaign=rss-feed" type="application/atom+xml" rel="alternate"
              title="Krystian Safjan's Blog Atom">

        <link href="https://www.safjan.com/feeds/all.rss.xml?utm_source=rss&utm_medium=feed&utm_campaign=rss-feed" type="application/rss+xml" rel="alternate"
              title="Krystian Safjan's Blog RSS">


    <link rel="apple-touch-icon" sizes="180x180" href="https://www.safjan.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.safjan.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.safjan.com/favicon-16x16.png">
    <link rel="shortcut icon" href="https://www.safjan.com/favicon.ico">
    <link rel="manifest" href="https://www.safjan.com/site.webmanifest">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-title" content="Krystian Safjan's Blog">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RM2PKDCCYM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RM2PKDCCYM');
</script>
<!-- End of Google tag (gtag.js) -->



    <meta name="author" content="Krystian Safjan"/>
    <meta name="description" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness."/>
    <meta name="keywords" content="retriever, rag, visuallization, rag-evaluation, logging, struct-log, rankflow, observability, callback">


  <meta property="og:site_name" content="Krystian Safjan's Blog"/>
  <meta property="og:title" content="RankFlow plot for retriever visual evaluation"/>
  <meta property="og:description" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.safjan.com/rankflow-plot-for-retriever-visual-evaluation/"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2024-07-08 00:00:00+02:00"/>
  <meta property="article:modified_time" content="2024-07-08 00:00:00+02:00"/>
  <meta property="article:author" content="https://www.safjan.com/author/krystian-safjan/"/>
  <meta property="article:section" content="Machine Learning"/>
  <meta property="article:tag" content="retriever"/>
  <meta property="article:tag" content="rag"/>
  <meta property="article:tag" content="visuallization"/>
  <meta property="article:tag" content="rag-evaluation"/>
  <meta property="article:tag" content="logging"/>
  <meta property="article:tag" content="struct-log"/>
  <meta property="article:tag" content="rankflow"/>
  <meta property="article:tag" content="observability"/>
  <meta property="article:tag" content="callback"/>
  <meta property="og:image" content="https://www.safjan.com//images/head/rankflow_plot_head.jpg"/>
  <meta property="og:image:width" content="1200"/>
  <meta property="og:image:height" content="630"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.safjan.com//images/head/rankflow_plot_head.jpg"/>
    <meta name="twitter:image:alt" content="RankFlow plot for retriever visual evaluation"/>


    <meta name="twitter:site" content="@izikeros"/>
    <meta name="twitter:creator" content="@izikeros"/>
    <meta name="twitter:title" content="RankFlow plot for retriever visual evaluation"/>
    <meta name="twitter:description" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to..."/>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.safjan.com/rankflow-plot-for-retriever-visual-evaluation/"
  },
  "headline": "RankFlow plot for retriever visual evaluation",
  "datePublished": "2024-07-08T00:00:00+02:00",
  "dateModified": "2024-07-08T00:00:00+02:00",
  "author": {
    "@type": "Person",
    "name": "Krystian Safjan",
    "url": "https://www.safjan.com/author/krystian-safjan/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Krystian Safjan's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/profile_new.jpg"
    }  },
"image": "https://www.safjan.com//images/head/rankflow_plot_head.jpg",  "url": "https://www.safjan.com/rankflow-plot-for-retriever-visual-evaluation/",
  "description": "RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is...",
  "articleSection": "Machine Learning",
  "inLanguage": "en",
  "keywords": "retriever, rag, visuallization, rag-evaluation, logging, struct-log, rankflow, observability, callback",
  "wordCount": 1553,
  "speakable": {
    "@type": "SpeakableSpecification",
    "cssSelector": ["article h1", ".summary", ".tldr", "article \u003e p:first-of-type"]
  }}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://www.safjan.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Machine Learning",
      "item": "https://www.safjan.com/category/machine-learning.html"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "RankFlow plot for retriever visual evaluation"
    }
  ]
}
</script>



<meta name="ai:summary" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness.">

<meta name="ai:topics" content="retriever, rag, visuallization, rag-evaluation, logging, struct-log, rankflow, observability, callback">



<meta name="ai:word-count" content="1553">
<meta name="ai:reading-time" content="7 min">

<meta name="ai:section" content="Machine Learning">



<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">

    <title>    RankFlow plot for retriever visual evaluation
</title>



<!-- Google Automatic Ads -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9767732578835199"
     crossorigin="anonymous"></script>
<!-- End of Google Automatic Ads -->


</head>
<body>
<div id="reading-progress" class="reading-progress"></div>
<aside>
    <div>
        <a href="https://www.safjan.com/">
                <img src="/images/profile_new.jpg" alt="Krystian Safjan's Blog" title="Krystian Safjan's Blog" width="140" height="140">
        </a>

        <h1>
            <a href="https://www.safjan.com/">Krystian Safjan's Blog</a>
        </h1>

<p>Data Scientist and Team Leader writing about Machine Learning, MLOps, and Python</p>


        <ul class="social">
                <li>
                    <a  class="sc-linkedin" href="https://pl.linkedin.com/in/krystiansafjan"
                       target="_blank">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/izikeros"
                       target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-envelope" href="mailto:ksafjan@gmail.com"
                       target="_blank">
                        <i class="fas fa-envelope"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-graduation-cap" href="https://scholar.google.pl/citations?user=UlNJgMoAAAAJ"
                       target="_blank">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-rss" href="/feeds/all.rss.xml"
                       target="_blank">
                        <i class="fas fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>

<div class="promo-box">
    <a href="https://ksafjanuser.gumroad.com/l/mlops" class="promo-box-image">
        <img src="/images/mlop_interview_book_cover_3D_300px.jpg" alt="MLOps Interview Book Cover">
    </a>
    
    <p class="promo-box-headline">Ace Your MLOps Interview</p>
    
    <a href="https://ksafjanuser.gumroad.com/l/mlops" class="promo-box-cta">
        Get for $2.99
    </a>
    
    <p class="promo-box-features">50 Q&A • PDF/ePUB/mobi</p>
</div>
</aside>
<main>

        <nav aria-label="Main navigation">
            <a href="https://www.safjan.com/">Home</a>

                <a href="/archives.html">Articles</a>
                <a href="/til.html">Notes</a>
                <a href="/categories.html">Categories</a>
                <a href="/pdfs/Krystian_Safjan_resume_priv.pdf">Resume</a>

                <a href="https://www.safjan.com/feeds/all.atom.xml">Atom</a>

                <a href="https://www.safjan.com/feeds/all.rss.xml">RSS</a>

            <div id="search" class="nav-search"></div>
            <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
            </button>
        </nav>

    <article class="single">
        <header>
                
            <p>
                <!-- Posted on: -->
                2024-07-08 


                <br/>
            </p>
            <h1>RankFlow plot for retriever visual evaluation</h1>
            <div class="header-underline"></div>
                <div class="summary"><p>RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness.</p></div>

                <div style="width: 100%; padding-bottom: 30px; position: relative;">
                    <a href="https://www.safjan.com/rankflow-plot-for-retriever-visual-evaluation/">
                        <img style="width: 100%; "
                             src="/images/head/rankflow_plot_head.jpg" alt="RankFlow plot for retriever visual evaluation">
                    </a>
                </div>


        </header>




        <div class="article-content">
            <!-- MarkdownTOC levels="2,3" autolink="true" autoanchor="true" -->

<ul>
<li><a href="#tldr">TLDR</a></li>
<li><a href="#introduction-and-problem-statement">Introduction and problem statement</a></li>
<li><a href="#inspiration---rank-flow-visualization">Inspiration - Rank flow visualization</a></li>
<li><a href="#tracking-the-rank-changes-in-your-rag">Tracking the rank changes in your RAG</a></li>
<li><a href="#rank-tracking-using-the-structured-logs">Rank tracking using the structured logs</a></li>
<li><a href="#how-to-track-with-struct-logs">How to track with struct logs?</a></li>
<li><a href="#rank-tracking-using-callbacks">Rank tracking using callbacks</a></li>
<li><a href="#how-to-track-retriever-data-with-callbacks">How to track retriever data with callbacks?</a></li>
<li><a href="#visualization">Visualization</a></li>
<li><a href="#references">References</a></li>
</ul>
<!-- /MarkdownTOC -->

<h2 id="tldr">TLDR</h2>
<p>This article discusses the importance of tracking and visualizing rank changes in Retrieval-Augmented Generation (RAG) systems. It introduces the concept of rank flow visualization, which helps analyze how document rankings evolve through different stages of retrieval and re-ranking. The article outlines methods for collecting rank data using structured logging and callbacks, and presents a Python library called 'rankflow' for creating visual representations of these rank changes. This visualization technique enables AI professionals to quickly identify patterns and optimize their RAG systems, ultimately improving the quality of information retrieval and generation.</p>
<h2 id="introduction-and-problem-statement">Introduction and problem statement</h2>
<p>Retrieval-Augmented Generation (RAG) systems are composed of two primary components: the <strong>retriever</strong> and the <strong>answer generator</strong>. The overall efficacy of RAG is largely contingent on the quality of the retriever, making it a critical area for optimization and analysis.</p>
<p>Advanced retrieval mechanisms often process numerous document fragments or nodes, which are initially ranked based on relevance. To enhance result quality, these nodes undergo <strong>multiple re-ranking phases</strong>, each aimed at surfacing the most pertinent information.</p>
<p>The re-ranking process can involve a variety of sophisticated techniques, including cross-encoders, bespoke re-ranking algorithms, and boosting systems. These methods serve to refine the rank of search results originating from diverse sources, such as traditional text search algorithms (e.g., BM25) and semantic search based on textual embeddings.</p>
<p><strong>Tracking the evolving ranks of these document nodes</strong> across multiple processing stages within the retriever can be a complex and time-consuming endeavor. However, leveraging the human brain's innate capacity for visual information processing offers a solution. By employing appropriate visualization techniques, we can significantly streamline the analysis of node rank fluctuations throughout the various retriever stages.</p>
<p>This is where tools like rankflow chart (called also bump chart) come into play, offering a <strong>visual representation of rank changes</strong> that allows for rapid comprehension and insights into the retriever's performance. Such visualizations enable AI professionals to efficiently identify patterns, anomalies, and opportunities for optimization in their RAG systems, ultimately leading to more effective and reliable information retrieval.</p>
<p>In this article we focus on two aspects of visual analysis of rank changes: collecting data in retriever and generating graphical visualization like this:</p>
<p><img alt="RankFlow Plot" src="/images/rankflow/rankflow_plot_full.jpg"></p>
<p><em><strong>Figure 1:</strong> RankFlow chart illustrating rank changes in four steps of re-ranking. You can track the given node's rank history visually. For example, Document 4, after hybrid search, initially had a rank of 4. Then, after the Cross-encoder surfaced, it was re-ranked to 1. The Graph re-ranker subsequently placed it at rank 6, and finally, the Booster changed its rank to 0.</em></p>
<h2 id="inspiration-rank-flow-visualization">Inspiration - Rank flow visualization</h2>
<p>When we started searching information about the tool that could help us to visualize how the ranks are changing, we found <a href="https://labs.polsys.net/tools/rankflow/">RankFlow</a> that can do, more or less, the visualization type we were looking for.</p>
<p><svg height="300" version="1.1" width="630" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.0546875px;"><path fill="url('#4130-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,122Q401.5,122,369.74,206T305.5,290L305.5,239Q337.5,239,369.26,155T433.5,71L433.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4120-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,290Q261.5,290,229.5,290T165.5,290L165.5,239Q197.5,239,229.5,239T293.5,239L293.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4110-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,290Q121.5,290,89.5,290T25.5,290L25.5,239Q57.5,239,89.5,239T153.5,239L153.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4100-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,290Q401.5,290,369.18,178T305.5,66L305.5,15Q337.5,15,369.82,127T433.5,239L433.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4090-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,66Q261.5,66,229.5,66T165.5,66L165.5,15Q197.5,15,229.5,15T293.5,15L293.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4080-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,66Q121.5,66,89.74,150T25.5,234L25.5,183Q57.5,183,89.26,99T153.5,15L153.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4070-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,66Q401.5,66,369.74,150T305.5,234L305.5,183Q337.5,183,369.26,99T433.5,15L433.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4060-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,234Q261.5,234,229.5,234T165.5,234L165.5,183Q197.5,183,229.5,183T293.5,183L293.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4050-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,234Q121.5,234,89.42,206T25.5,178L25.5,127Q57.5,127,89.58,155T153.5,183L153.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4040-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,234Q401.5,234,369.42,206T305.5,178L305.5,127Q337.5,127,369.58,155T433.5,183L433.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4030-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,178Q261.5,178,229.5,178T165.5,178L165.5,127Q197.5,127,229.5,127T293.5,127L293.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4020-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,178Q121.5,178,89.42,150T25.5,122L25.5,71Q57.5,71,89.58,99T153.5,127L153.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4010-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,178Q401.5,178,369.42,150T305.5,122L305.5,71Q337.5,71,369.58,99T433.5,127L433.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4000-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,122Q261.5,122,229.5,122T165.5,122L165.5,71Q197.5,71,229.5,71T293.5,71L293.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#3990-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,122Q121.5,122,89.42,94T25.5,66L25.5,15Q57.5,15,89.58,43T153.5,71L153.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><linearGradient id="3990-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4000-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4010-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4020-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4030-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4040-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4050-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4060-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4070-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4080-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4090-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4100-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4110-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4120-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4130-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient></defs><path fill="none" stroke="#000000" d="M8.5,300.5L8.5,0.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><text x="3" y="291" text-anchor="end" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: end; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">0</tspan></text><text x="3" y="20" text-anchor="end" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: end; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">5</tspan></text><text x="13" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_1</tspan></text><rect x="13.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="153" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_2</tspan></text><rect x="153.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="293" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_3</tspan></text><rect x="293.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="433" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_4</tspan></text><rect x="433.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="27.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="167.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="307.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="447.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="27.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="167.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="307.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="447.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="27.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="167.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="307.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="447.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="27.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="167.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="307.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="447.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="27.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="167.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="307.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="447.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text></svg> |</p>
<p>You can create the Excel table that reflect rank of the documents on each step. Note that the RankFlow tool supports also column with values that is responsible for the width of the "ribbon". You can use it to e.g. visualize importance of given node, or how many information from this node was finally used in the generated answer (if you have this type of information at hand).</p>
<table>
<thead>
<tr>
<th>Step_1</th>
<th>val_1</th>
<th>Step_2</th>
<th>val_2</th>
<th>Step_3</th>
<th>val_3</th>
<th>Step_4</th>
<th>val_4</th>
</tr>
</thead>
<tbody>
<tr>
<td>doc_1_1</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
</tr>
<tr>
<td>doc_12_3</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
</tr>
<tr>
<td>doc_2_2</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
</tr>
<tr>
<td>doc_1_3</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
</tr>
<tr>
<td>doc_2_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>This tool was an appetiser to have something similar implemented in Python. Before going to visualization, let's spent some time on how to collect data required for this visual analysis.</p>
<h2 id="tracking-the-rank-changes-in-your-rag">Tracking the rank changes in your RAG</h2>
<p>This is a separate topic - depending on the architecture of your retriever. I envision two main approaches:</p>
<ul>
<li>using structured logging</li>
<li>using callbacks</li>
<li>using dedicated monitoring/<a href="https://www.safjan.com/open-source-llm-observability-tools-and-platforms/">Open Source LLM Observability Tools and Platforms</a></li>
</ul>
<p>Here, we will discuss only first two since they are pretty while skipping the specific observability tools.</p>
<h3 id="rank-tracking-using-the-structured-logs">Rank tracking using the structured logs</h3>
<blockquote>
<p><strong>What are the struct logs?</strong>
Structured logs are a standardized format for logging data where information is organized into consistent, machine-readable fields rather than free-form text. <strong>They typically use formats like JSON or key-value pairs</strong>, making it easier to parse, search, and analyze log data programmatically. The benefits of using structured logs include improved log consistency, easier data extraction and analysis, better integration with log management tools, and enhanced ability to generate insights and troubleshoot issues in complex systems.</p>
</blockquote>
<h3 id="how-to-track-with-struct-logs">How to track with struct logs?</h3>
<p><a href="">Struct log</a> have the advantage over non-structured log that you can easily, and with more confidentiality, extract data from it without using sophisticated log parsers. In Python, you can use loguru to drop the rank information to the separate log sink after each step that involves some form of reranking and trace e.g. node (chunk) id, new rank, and "label" for the reranking step. In this way you will get a jsonlines log file with all the data you need to create visualization. You can read more about how to use struct logs with loguru in <a href="">loguru docs</a> and <a href="">this</a> article.</p>
<h3 id="rank-tracking-using-callbacks">Rank tracking using callbacks</h3>
<blockquote>
<p><strong>What are the callbacks?</strong>
Callbacks in programming are functions passed as arguments to other functions, which are then executed at specific points during the execution of the containing function. In the context of machine learning and deep learning frameworks, callbacks are often used to track and log various metrics, execute custom actions, or modify behavior during training or inference.</p>
</blockquote>
<h3 id="how-to-track-retriever-data-with-callbacks">How to track retriever data with callbacks?</h3>
<p>Here is an example how you can use callbacks to track re-ranking info in dummy implementation of the retriever with some re-ranking steps.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>

<span class="k">class</span> <span class="nc">Document</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>

<span class="k">class</span> <span class="nc">RankingTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">log_ranking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]):</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">score</span><span class="p">}</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;ranking&quot;</span><span class="p">:</span> <span class="n">ranking</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rankings</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Retriever</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">get_relevant_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="c1"># Simulated retrieval</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 1&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 2&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 3&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
        <span class="p">]</span>

<span class="k">def</span> <span class="nf">cross_encoder_rerank</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Simulated cross-encoder re-ranking</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mf">0.1</span>  <span class="c1"># Simulate score adjustment</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">custom_rerank</span><span class="p">(</span><span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Simulated custom re-ranking</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">*=</span> <span class="mf">1.2</span>  <span class="c1"># Simulate score adjustment</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rag_retrieval</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retriever</span><span class="p">:</span> <span class="n">Retriever</span><span class="p">,</span>
                  <span class="n">rerankers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span>
                  <span class="n">tracker</span><span class="p">:</span> <span class="n">RankingTracker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Initial retrieval</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">log_ranking</span><span class="p">(</span><span class="s2">&quot;initial_retrieval&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>

    <span class="c1"># Apply each re-ranker</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reranker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rerankers</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">reranker</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;query&#39;</span> <span class="ow">in</span> <span class="n">reranker</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span> <span class="k">else</span> <span class="n">reranker</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">log_ranking</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rerank_step_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">docs</span>
</code></pre></div>

<p>In this code above:</p>
<ol>
<li>We define a simple <code>Document</code> class to represent our documents.</li>
<li>The <code>RankingTracker</code> class is responsible for logging rankings at each step and writing them to a file.</li>
<li>We have a basic <code>Retriever</code> class that simulates initial document retrieval.</li>
<li>Two re-ranking functions are defined: <code>cross_encoder_rerank</code> and <code>custom_rerank</code>. These simulate different re-ranking strategies.</li>
<li>The <code>rag_retrieval</code> function orchestrates the entire process:<ul>
<li>It first retrieves documents using the retriever.</li>
<li>Then it applies each re-ranker in sequence.</li>
<li><strong>After each step, it logs the current ranking using the tracker</strong>.</li>
</ul>
</li>
</ol>
<p>Here is the usage, with steps:</p>
<ul>
<li>Initialize the tracker and retriever.</li>
<li>Call <code>rag_retrieval</code> with the query, retriever, list of re-rankers, and tracker.</li>
<li>Print the final rankings.</li>
<li>Flush the tracked rankings to a file.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Usage</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">RankingTracker</span><span class="p">(</span><span class="s2">&quot;ranking_results.json&quot;</span><span class="p">)</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">Retriever</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is the capital of France?&quot;</span>

    <span class="n">final_docs</span> <span class="o">=</span> <span class="n">rag_retrieval</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">retriever</span><span class="p">,</span>
        <span class="p">[</span><span class="n">cross_encoder_rerank</span><span class="p">,</span> <span class="n">custom_rerank</span><span class="p">],</span>
        <span class="n">tracker</span>
    <span class="p">)</span>

    <span class="c1"># Print final rankings</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final document rankings:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">final_docs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save all rankings to file</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>

<h2 id="visualization">Visualization</h2>
<p>For the visualization part you can use small Python library <a href="https://pypi.org/project/rankflow/">rankflow</a> (disclaimer: I'm the author) that is able to produce this type of visualization:
<img alt="RankFlow Plot" src="/images/rankflow/rankflow_plot_full.jpg"></p>
<p>First, install it with pip:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>rankflow
</code></pre></div>

<p>It can accept various input data formats, one, convenient for data scientists is pandas data frame.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">rankflow</span> <span class="kn">import</span> <span class="n">RankFlow</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Doc 1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Doc 2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;Doc 3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Step_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_3&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_4&quot;</span><span class="p">])</span>
</code></pre></div>

<p>When the DataFrame is ready, then it is time to create RankFlow object and call <code>plot()</code> method.</p>
<div class="highlight"><pre><span></span><code><span class="n">rf</span> <span class="o">=</span> <span class="n">RankFlow</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># save the plot to png</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;rankflow.png&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p>If you found this library useful, please star the <a href="https://github.com/izikeros/rankflow">repo</a>.</p>
<p>With plotting options you have also some alternatives that you can use or take inspiration to create you own, customized rankflow plot/bump chart. See the references for alternatives.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.vrogue.co/post/how-to-plot-bump-chart-in-r-finnstats">How To Plot Bump Chart In R Finnstats - vrogue.co</a></li>
<li><a href="https://github.com/kartikay-bagla/bump-plot-python">GitHub - kartikay-bagla/bump-plot-python</a></li>
<li><a href="https://mplsoccer.readthedocs.io/en/latest/gallery/bumpy_charts/plot_bumpy.html#sphx-glr-gallery-bumpy-charts-plot-bumpy-py">Bumpy Charts - mplsoccer 1.2.4 documentation</a></li>
<li><a href="https://nbviewer.org/gist/pascal-schetelat/8382651">Jupyter Notebook Viewer</a></li>
</ul>
        </div>




            <div class="bibtex-note">
                <p><b>To cite this article:</b></p>
                <pre>@article{Saf2024RankFlow,
    author  = {Krystian Safjan},
    title   = {RankFlow plot for retriever visual evaluation},
    journal = {Krystian's Safjan Blog},
    year    = {2024},
}</pre>
            </div>
        <div class="article-tags">
            <span class="tags-label">Tags:</span>
                <a href="https://www.safjan.com/tag/retriever/" class="article-tag">retriever</a>
                <a href="https://www.safjan.com/tag/rag/" class="article-tag">rag</a>
                <a href="https://www.safjan.com/tag/visuallization/" class="article-tag">visuallization</a>
                <a href="https://www.safjan.com/tag/rag-evaluation/" class="article-tag">rag-evaluation</a>
                <a href="https://www.safjan.com/tag/logging/" class="article-tag">logging</a>
                <a href="https://www.safjan.com/tag/struct-log/" class="article-tag">struct-log</a>
                <a href="https://www.safjan.com/tag/rankflow/" class="article-tag">rankflow</a>
                <a href="https://www.safjan.com/tag/observability/" class="article-tag">observability</a>
                <a href="https://www.safjan.com/tag/callback/" class="article-tag">callback</a>
        </div>







            <div class="related-posts">
                <h4 class="related-posts-title">You might also like</h4>
                <div class="related-posts-grid">
                        <a href="https://www.safjan.com/ragas-mlflow-rag-evaluation-tutorial/" class="related-post-card">
                            <span class="related-post-title">RAG Evaluation with RAGAS and MLflow - A Practical Guide</span>
                            <span class="related-post-date">Jan 08, 2026</span>
                        </a>
                        <a href="https://www.safjan.com/rag-fusion-enhancing-information-retrieval-in-large-language-models/" class="related-post-card">
                            <span class="related-post-title">RAG-Fusion - Enhancing Information Retrieval in Large Language Models</span>
                            <span class="related-post-date">Nov 06, 2023</span>
                        </a>
                        <a href="https://www.safjan.com/techniques-to-boost-rag-performance-in-production/" class="related-post-card">
                            <span class="related-post-title">Techniques to Boost RAG Performance in Production</span>
                            <span class="related-post-date">Nov 01, 2023</span>
                        </a>
                        <a href="https://www.safjan.com/from-fixed-size-to-nlp-chunking-a-deep-dive-into-text-chunking-techniques/" class="related-post-card">
                            <span class="related-post-title">From Fixed-Size to NLP Chunking - A Deep Dive into Text Chunking Techniques</span>
                            <span class="related-post-date">Sep 11, 2023</span>
                        </a>
                </div>
            </div>




    </article>

    <footer>
<p>
  &copy; 2026 Krystian Safjan - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>    </footer>
</main>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": "Krystian Safjan's Blog",
  "url": "https://www.safjan.com",
"image": "/images/profile_new.jpg",  "description": ""
}
</script>


<script src="/pagefind/pagefind-ui.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', function() {
        new PagefindUI({
            element: "#search",
            showSubResults: false,
            showImages: false,
            basePath: "/pagefind/"
        });
    });
</script>

<script src="https://www.safjan.com/theme/js/theme-switcher.js"></script>

<style>
.video-embed {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    background: #000;
    border-radius: 0.375rem;
    overflow: hidden;
}
.video-embed iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
}
.video-embed-wrapper {
    margin-bottom: 1rem;
}
.video-embed-info {
    padding: 0.5rem 0.75rem;
    background: var(--color-bg-secondary, #f6f8fa);
    border-radius: 0 0 0.375rem 0.375rem;
    font-size: 0.875rem;
    margin-top: -0.375rem;
}
.video-embed-info a {
    text-decoration: none;
    color: inherit;
}
.video-embed-info a:hover {
    text-decoration: underline;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('pre > code').forEach(function(code) {
        var text = code.textContent.trim();
        var lines = text.split('\n');
        var url = lines[0].trim();

        var videoId = null;
        var embedUrl = null;
        var platform = null;

        // YouTube detection
        var ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
        if (ytMatch) {
            videoId = ytMatch[1];
            embedUrl = 'https://www.youtube-nocookie.com/embed/' + videoId;
            platform = 'youtube';
        }

        // Vimeo detection
        var vimeoMatch = url.match(/vimeo\.com\/(?:video\/)?(\d+)/);
        if (vimeoMatch) {
            videoId = vimeoMatch[1];
            embedUrl = 'https://player.vimeo.com/video/' + videoId + '?dnt=1';
            platform = 'vimeo';
        }

        if (!videoId || !embedUrl) return;

        var meta = {};
        lines.slice(1).forEach(function(line) {
            var m = line.match(/^(\w+):\s*(.+)$/);
            if (m) meta[m[1].toLowerCase()] = m[2].trim();
        });

        var wrapper = document.createElement('div');
        wrapper.className = 'video-embed-wrapper';

        var embed = document.createElement('div');
        embed.className = 'video-embed';
        embed.innerHTML = '<iframe src="' + embedUrl +
            '" allowfullscreen loading="lazy" title="' + (meta.title || (platform === 'youtube' ? 'YouTube video' : 'Vimeo video')).replace(/"/g, '&quot;') + '"></iframe>';
        wrapper.appendChild(embed);

        if (meta.title || meta.author) {
            var info = document.createElement('div');
            info.className = 'video-embed-info';
            var html = meta.title ? '<strong>' + meta.title + '</strong>' : '';
            if (meta.author) {
                html += (meta.title ? ' &bull; ' : '');
                html += meta.authorurl ? '<a href="' + meta.authorurl + '" target="_blank" rel="noopener">' + meta.author + '</a>' : meta.author;
            }
            info.innerHTML = html;
            wrapper.appendChild(info);
        }
        code.closest('pre').replaceWith(wrapper);
    });
});
</script>

<style>
.tweet-embed-wrapper {
    margin-bottom: 1rem;
}
.tweet-embed-loading {
    padding: 1rem;
    background: var(--color-bg-secondary, #f6f8fa);
    border-radius: 0.375rem;
    color: var(--color-text-secondary, #6c757d);
    font-size: 0.875rem;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var twitterScriptLoaded = false;

    function loadTwitterScript() {
        if (twitterScriptLoaded) return;
        twitterScriptLoaded = true;
        var script = document.createElement('script');
        script.src = 'https://platform.twitter.com/widgets.js';
        script.async = true;
        document.body.appendChild(script);
    }

    document.querySelectorAll('pre > code.language-tweet').forEach(function(code) {
        var text = code.textContent.trim();
        var url = text.split('\n')[0].trim();

        // Twitter/X URL detection
        var tweetMatch = url.match(/^https?:\/\/(twitter\.com|x\.com)\/\w+\/status\/(\d+)/);
        if (!tweetMatch) return;

        var wrapper = document.createElement('div');
        wrapper.className = 'tweet-embed-wrapper';
        wrapper.innerHTML = '<div class="tweet-embed-loading">Loading tweet...</div>';

        code.closest('pre').replaceWith(wrapper);

        // Fetch oEmbed data
        var oembedUrl = 'https://publish.twitter.com/oembed?url=' + encodeURIComponent(url) + '&dnt=true&omit_script=true';

        fetch(oembedUrl)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                wrapper.innerHTML = data.html;
                loadTwitterScript();
                if (window.twttr && window.twttr.widgets) {
                    window.twttr.widgets.load(wrapper);
                }
            })
            .catch(function() {
                wrapper.innerHTML = '<div class="tweet-embed-loading">Failed to load tweet. <a href="' + url + '" target="_blank" rel="noopener">View on Twitter</a></div>';
            });
    });
});
</script>
</body>
</html>