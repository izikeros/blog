
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"/>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap"
              rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/stylesheet/style.min.css">



        <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              href="https://www.safjan.com/theme/pygments/github.min.css">



    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/solid.css">

        <link rel="stylesheet" type="text/css"
              href="https://www.safjan.com/styles/custom.css">

        <link href="https://www.safjan.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Krystian Safjan's Blog Atom">

        <link href="https://www.safjan.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Krystian Safjan's Blog RSS">


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RM2PKDCCYM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RM2PKDCCYM');
</script>
<!-- End of Google tag (gtag.js) -->



    <meta name="author" content="Krystian Safjan"/>
    <meta name="description" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness."/>
    <meta name="keywords" content="retriever, rag, visuallization, rag-evaluation, logging, struct-log, rankflow, observability, callback">
    <meta expr:content="2024-07-08 00:00:00+02:00" itemprop='datePublished'/>
    <meta expr:content="2024-07-08 00:00:00+02:00" itemprop='dateModified'/>
    <meta property="article:modified_time" content="2024-07-08 00:00:00+02:00"/>
    <meta property="article:published_time" content="2024-07-08 00:00:00+02:00"/>
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RankFlow plot for retriever visual evaluation",
  "datePublished": "2024-07-08 00:00:00+02:00",
  "dateModified": "2024-07-08 00:00:00+02:00"
}

    </script>



  <meta property="og:site_name" content="Krystian Safjan's Blog"/>
  <meta property="og:title" content="RankFlow plot for retriever visual evaluation"/>
  <meta property="og:description" content="RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.safjan.com/drafts/rankflow-plot-for-retriever-visual-evaluation.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2024-07-08 00:00:00+02:00"/>
  <meta property="article:modified_time" content="2024-07-08 00:00:00+02:00"/>
  <meta property="article:author" content="https://www.safjan.com/author/krystian-safjan/">
  <meta property="article:section" content="Machine Learning"/>
  <meta property="article:tag" content="retriever"/>
  <meta property="article:tag" content="rag"/>
  <meta property="article:tag" content="visuallization"/>
  <meta property="article:tag" content="rag-evaluation"/>
  <meta property="article:tag" content="logging"/>
  <meta property="article:tag" content="struct-log"/>
  <meta property="article:tag" content="rankflow"/>
  <meta property="article:tag" content="observability"/>
  <meta property="article:tag" content="callback"/>
  <meta property="og:image" content="https://www.safjan.com//images/head/rankflow_plot_head.jpg">

    <meta name="twitter:card" content="summary"/>
    <meta property="twitter:image" content="https://www.safjan.com//images/head/rankflow_plot_head.jpg">

    <meta name="twitter:label1" content="Est. reading time"/>
    <meta name="twitter:data1" content="4 min."/>
    <meta name="twitter:site" content="@izikeros"/>
    <meta name="twitter:description" content="<p>RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness.</p>"/>
    <meta name="twitter:title" content="RankFlow plot for retriever visual evaluation"/>


    <title>    RankFlow plot for retriever visual evaluation
</title>



<!-- Google Automatic Ads -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9767732578835199"
     crossorigin="anonymous"></script>
<!-- End of Google Automatic Ads -->


</head>
<body class="light-theme">
<aside>
    <div>
        <a href="https://www.safjan.com/">
                <img src="/images/profile_new.jpg" alt="Krystian Safjan's Blog" title="Krystian Safjan's Blog" width="140" height="140">
        </a>

        <h1>
            <a href="https://www.safjan.com/">Krystian Safjan's Blog</a>
        </h1>

<p>Data Scientist | Researcher | Team Leader<br><br> working at Ernst &amp; Young and writing about <a href="/category/machine-learning.html">Data Science and Visualization</a>, on <a href="/category/machine-learning.html">Machine Learning, Deep Learning</a> and <a href="/tag/nlp/">NLP</a>. There are also some  <a href="/category/howto.html">howto</a> posts on tools and workflows.</p>




        <ul class="social">
                <li>
                    <a  class="sc-linkedin" href="https://pl.linkedin.com/in/krystiansafjan"
                       target="_blank">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/izikeros"
                       target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-envelope" href="mailto:ksafjan@gmail.com"
                       target="_blank">
                        <i class="fas fa-envelope"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-graduation-cap" href="https://scholar.google.pl/citations?user=UlNJgMoAAAAJ"
                       target="_blank">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-rss" href="/feeds/all.rss.xml"
                       target="_blank">
                        <i class="fas fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>

<style>
    .button {
        background-color: yellow;
        color: black;
        border: none;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 20px;
    }

    .center {
        text-align: center;
    }

    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }

    .left-col {
    }

    .right-col {
    }

    .image {
        border-radius: 0;
        width: 100%;
    }

    .book-list {
        padding-top:0;
        padding-bottom: 0;
        text-align:left;
        box-sizing: border-box;
        display: block;
        list-style-image: url(/images/shortcode-tick.webp);
        margin-block-start: 1em;
        margin-block-end: 1em;
        margin-inline-start:0;
        margin-inline-end:0;
        padding-inline-start:40px;
    }

    .book-list li {
        font-weight: bold;
    }

    @media (max-width: 600px) {
        .container {
            grid-template-columns: 1fr;
        }
    }

</style>
<div class="container">
    <div class="left-col">
        <a href="https://ksafjanuser.gumroad.com/l/mlops">
            <img src="/images/mlop_interview_book_cover_3D_300px.jpg" class="image" alt="Interview Book Cover">
        </a>

        <div class="center">
            <a href="https://ksafjanuser.gumroad.com/l/mlops">
                <button class="button">Get for $2.99</button>
            </a>
        </div>
    </div>
    <div class="right-col">
        <div>
            <ul class="book-list">
                <li>PDF, ePUB, mobi format ebook, no DRM</li>
                <li>50 questions and answers</li>
                <li>Stories from real projects</li>
                <li>92 multiple choice quiz questions</li>
                <li>80 pages</li>
            </ul>
        </div>
    </div>
</div>
</aside>
<main>

        <nav>
            <a href="https://www.safjan.com/">Home</a>

                <a href="/archives.html">Articles</a>
                <a href="/til.html">Notes</a>
                <a href="/categories.html">Categories</a>
                <a href="/pdfs/Krystian_Safjan_resume_priv.pdf">Resume</a>

                <a href="https://www.safjan.com/feeds/all.atom.xml">Atom</a>

                <a href="https://www.safjan.com/feeds/all.rss.xml">RSS</a>
        </nav>

    <article class="single">
        <header>
                
            <p>
                <!-- Posted on: -->
                2024-07-08 


                <br/>
            </p>
            <h1 id="rankflow-plot-for-retriever-visual-evaluation">RankFlow plot for retriever visual evaluation</h1>
            <div class="header-underline"></div>
                <p class="summary"><p>RAG systems depend on high-quality retrieval to surface relevant information. Analyzing how document rankings evolve through multiple re-ranking steps is complex. This article explores ways to collect ranking data and visualize rank changes to optimize retriever effectiveness.</p></p>



        </header>


        <div>
            <!-- MarkdownTOC levels="2,3" autolink="true" autoanchor="true" -->

<ul>
<li><a href="#introduction-and-problem-statement">Introduction and problem statement</a></li>
<li><a href="#inspiration---rank-flow-visualization">Inspiration - Rank flow visualization</a></li>
<li><a href="#tracking-the-rank-changes-in-your-rag">Tracking the rank changes in your RAG</a></li>
<li><a href="#rank-tracking-using-the-structured-logs">Rank tracking using the structured logs</a></li>
<li><a href="#how-to-track-with-struct-logs">How to track with struct logs?</a></li>
<li><a href="#rank-tracking-using-callbacks">Rank tracking using callbacks</a></li>
<li><a href="#how-to-track-retriever-data-with-callbacks">How to track retriever data with callbacks?</a></li>
<li><a href="#visualization">Visualization</a></li>
<li><a href="#references">References</a></li>
</ul>
<!-- /MarkdownTOC -->

<p><a id="introduction-and-problem-statement"></a></p>
<h2>Introduction and problem statement</h2>
<p>Retrieval-Augmented Generation (RAG) systems are composed of two primary components: the <strong>retriever</strong> and the <strong>answer generator</strong>. The overall efficacy of RAG is largely contingent on the quality of the retriever, making it a critical area for optimization and analysis.</p>
<p>Advanced retrieval mechanisms often process numerous document fragments or nodes, which are initially ranked based on relevance. To enhance result quality, these nodes undergo <strong>multiple re-ranking phases</strong>, each aimed at surfacing the most pertinent information.</p>
<p>The re-ranking process can involve a variety of sophisticated techniques, including cross-encoders, bespoke re-ranking algorithms, and boosting systems. These methods serve to refine the rank of search results originating from diverse sources, such as traditional text search algorithms (e.g., BM25) and semantic search based on textual embeddings.</p>
<p><strong>Tracking the evolving ranks of these document nodes</strong> across multiple processing stages within the retriever can be a complex and time-consuming endeavor. However, leveraging the human brain's innate capacity for visual information processing offers a solution. By employing appropriate visualization techniques, we can significantly streamline the analysis of node rank fluctuations throughout the various retriever stages.</p>
<p>This is where tools like rankflow chart (called also bump chart) come into play, offering a <strong>visual representation of rank changes</strong> that allows for rapid comprehension and insights into the retriever's performance. Such visualizations enable AI professionals to efficiently identify patterns, anomalies, and opportunities for optimization in their RAG systems, ultimately leading to more effective and reliable information retrieval.</p>
<p>In this article we focus on two aspects of visual analysis of rank changes: collecting data in retriever and generating graphical visualization like this:</p>
<p><img alt="RankFlow Plot" src="/images/rankflow/rankflow_plot_full.jpg">
Here is the rewritten text with grammar and spelling corrections:</p>
<p><em><strong>Figure 1:</strong> RankFlow chart illustrating rank changes in four steps of re-ranking. You can track the given node's rank history visually. For example, Document 4, after hybrid search, initially had a rank of 4. Then, after the Cross-encoder surfaced, it was re-ranked to 1. The Graph re-ranker subsequently placed it at rank 6, and finally, the Booster changed its rank to 0.</em></p>
<p><a id="inspiration---rank-flow-visualization"></a></p>
<h2>Inspiration - Rank flow visualization</h2>
<p>When we started searching information about the tool that could help us to visualize how the ranks are changing, we found <a href="https://labs.polsys.net/tools/rankflow/">RankFlow</a> that can do, more or less, the visualization type we were looking for.</p>
<p><svg height="300" version="1.1" width="630" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.0546875px;"><path fill="url('#4130-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,122Q401.5,122,369.74,206T305.5,290L305.5,239Q337.5,239,369.26,155T433.5,71L433.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4120-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,290Q261.5,290,229.5,290T165.5,290L165.5,239Q197.5,239,229.5,239T293.5,239L293.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4110-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,290Q121.5,290,89.5,290T25.5,290L25.5,239Q57.5,239,89.5,239T153.5,239L153.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4100-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,290Q401.5,290,369.18,178T305.5,66L305.5,15Q337.5,15,369.82,127T433.5,239L433.5,290" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4090-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,66Q261.5,66,229.5,66T165.5,66L165.5,15Q197.5,15,229.5,15T293.5,15L293.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4080-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,66Q121.5,66,89.74,150T25.5,234L25.5,183Q57.5,183,89.26,99T153.5,15L153.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4070-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,66Q401.5,66,369.74,150T305.5,234L305.5,183Q337.5,183,369.26,99T433.5,15L433.5,66" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4060-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,234Q261.5,234,229.5,234T165.5,234L165.5,183Q197.5,183,229.5,183T293.5,183L293.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4050-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,234Q121.5,234,89.42,206T25.5,178L25.5,127Q57.5,127,89.58,155T153.5,183L153.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4040-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,234Q401.5,234,369.42,206T305.5,178L305.5,127Q337.5,127,369.58,155T433.5,183L433.5,234" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4030-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,178Q261.5,178,229.5,178T165.5,178L165.5,127Q197.5,127,229.5,127T293.5,127L293.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4020-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,178Q121.5,178,89.42,150T25.5,122L25.5,71Q57.5,71,89.58,99T153.5,127L153.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4010-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M433.5,178Q401.5,178,369.42,150T305.5,122L305.5,71Q337.5,71,369.58,99T433.5,127L433.5,178" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#4000-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M293.5,122Q261.5,122,229.5,122T165.5,122L165.5,71Q197.5,71,229.5,71T293.5,71L293.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><path fill="url('#3990-rgb_200_0_55_-rgb_200_0_55_')" stroke="#ffffff" d="M153.5,122Q121.5,122,89.42,94T25.5,66L25.5,15Q57.5,15,89.58,43T153.5,71L153.5,122" stroke-width="1px" opacity="1" fill-opacity="1" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); opacity: 0.35; fill-opacity: 1;"></path><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with RaphaÃ«l 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><linearGradient id="3990-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4000-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4010-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4020-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4030-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4040-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4050-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4060-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4070-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4080-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4090-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4100-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4110-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4120-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient><linearGradient id="4130-rgb_200_0_55_-rgb_200_0_55_" x1="0" y1="0" x2="1" y2="0" gradientTransform="matrix(1,0,0,1,0,0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><stop offset="0%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop><stop offset="100%" stop-color="#c80037" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></stop></linearGradient></defs><path fill="none" stroke="#000000" d="M8.5,300.5L8.5,0.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><text x="3" y="291" text-anchor="end" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: end; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">0</tspan></text><text x="3" y="20" text-anchor="end" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: end; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">5</tspan></text><text x="13" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_1</tspan></text><rect x="13.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="13.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="153" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_2</tspan></text><rect x="153.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="153.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="293" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_3</tspan></text><rect x="293.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="293.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="433" y="5" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Step_4</tspan></text><rect x="433.5" y="15.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="71.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="127.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="183.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><rect x="433.5" y="239.5" width="12" height="51" rx="0" ry="0" fill="#c80037" stroke="#000000" stroke-width="1px" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></rect><text x="27.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="167.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="307.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="447.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_1 (1)</tspan></text><text x="27.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="167.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="307.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="447.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_12_3 (1)</tspan></text><text x="27.5" y="153" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="167.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="307.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="447.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_2 (1)</tspan></text><text x="27.5" y="209" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="167.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="307.5" y="41" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="447.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_1_3 (1)</tspan></text><text x="27.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="167.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="307.5" y="265" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text><text x="447.5" y="97" text-anchor="start" font-family="&quot;Arial&quot;" font-size="10px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 10px;"><tspan dy="3.44775390625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">doc_2_1 (1)</tspan></text></svg> |</p>
<p>You can create the Excel table that reflect rank of the documents on each step. Note that the RankFlow tool supports also column with values that is responsible for the width of the "ribbon". You can use it to e.g. visualize importance of given node, or how many information from this node was finally used in the generated answer (if you have this type of information at hand).</p>
<table>
<thead>
<tr>
<th>Step_1</th>
<th>val_1</th>
<th>Step_2</th>
<th>val_2</th>
<th>Step_3</th>
<th>val_3</th>
<th>Step_4</th>
<th>val_4</th>
</tr>
</thead>
<tbody>
<tr>
<td>doc_1_1</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
</tr>
<tr>
<td>doc_12_3</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
</tr>
<tr>
<td>doc_2_2</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
<td>doc_1_1</td>
<td>1</td>
</tr>
<tr>
<td>doc_1_3</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
<td>doc_2_2</td>
<td>1</td>
<td>doc_12_3</td>
<td>1</td>
</tr>
<tr>
<td>doc_2_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
<td>doc_2_1</td>
<td>1</td>
<td>doc_1_3</td>
<td>1</td>
</tr>
<tr>
<td>This tool was an appetiser to have something similar implemented in Python. Before going to visualization, let's spent some time on how to collect data required for this visual analysis.</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a id="tracking-the-rank-changes-in-your-rag"></a></p>
<h2>Tracking the rank changes in your RAG</h2>
<p>This is a separate topic - depending on the architecture of your retriever. I envision two main approaches:</p>
<ul>
<li>using structured logging</li>
<li>using callbacks</li>
<li>using dedicated monitoring/<a href="https://www.safjan.com/open-source-llm-observability-tools-and-platforms/">Open Source LLM Observability Tools and Platforms</a></li>
</ul>
<p>Here, we will discuss only first two since they are pretty while skipping the specific observability tools.</p>
<p><a id="rank-tracking-using-the-structured-logs"></a></p>
<h3>Rank tracking using the structured logs</h3>
<blockquote>
<p><strong>What are the struct logs?</strong>
Structured logs are a standardized format for logging data where information is organized into consistent, machine-readable fields rather than free-form text. <strong>They typically use formats like JSON or key-value pairs</strong>, making it easier to parse, search, and analyze log data programmatically. The benefits of using structured logs include improved log consistency, easier data extraction and analysis, better integration with log management tools, and enhanced ability to generate insights and troubleshoot issues in complex systems.</p>
</blockquote>
<p><a id="how-to-track-with-struct-logs"></a></p>
<h3>How to track with struct logs?</h3>
<p><a href="">Struct log</a> have the advantage over non-structured log that you can easily, and with more confidentiality, extract data from it without using sophisticated log parsers. In Python, you can use loguru to drop the rank information to the separate log sink after each step that involves some form of reranking and trace e.g. node (chunk) id, new rank, and "label" for the reranking step. In this way you will get a jsonlines log file with all the data you need to create visualization. You can read more about how to use struct logs with loguru in <a href="">loguru docs</a> and <a href="">this</a> article.</p>
<p><a id="rank-tracking-using-callbacks"></a></p>
<h3>Rank tracking using callbacks</h3>
<blockquote>
<p><strong>What are the callbacks?</strong>
Callbacks in programming are functions passed as arguments to other functions, which are then executed at specific points during the execution of the containing function. In the context of machine learning and deep learning frameworks, callbacks are often used to track and log various metrics, execute custom actions, or modify behavior during training or inference.</p>
</blockquote>
<p><a id="how-to-track-retriever-data-with-callbacks"></a></p>
<h3>How to track retriever data with callbacks?</h3>
<p>Here is an example how you can use callbacks to track re-reanking info in dummy implementation of the retriever with some re-ranking steps.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>

<span class="k">class</span> <span class="nc">Document</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>

<span class="k">class</span> <span class="nc">RankingTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">log_ranking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]):</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="o">.</span><span class="n">score</span><span class="p">}</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span> <span class="s2">&quot;ranking&quot;</span><span class="p">:</span> <span class="n">ranking</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rankings</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Retriever</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">get_relevant_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="c1"># Simulated retrieval</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 1&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 2&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
            <span class="n">Document</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;Content 3&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
        <span class="p">]</span>

<span class="k">def</span> <span class="nf">cross_encoder_rerank</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Simulated cross-encoder re-ranking</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mf">0.1</span>  <span class="c1"># Simulate score adjustment</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">custom_rerank</span><span class="p">(</span><span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Simulated custom re-ranking</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">score</span> <span class="o">*=</span> <span class="mf">1.2</span>  <span class="c1"># Simulate score adjustment</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rag_retrieval</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retriever</span><span class="p">:</span> <span class="n">Retriever</span><span class="p">,</span>
                  <span class="n">rerankers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span>
                  <span class="n">tracker</span><span class="p">:</span> <span class="n">RankingTracker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="c1"># Initial retrieval</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">log_ranking</span><span class="p">(</span><span class="s2">&quot;initial_retrieval&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>

    <span class="c1"># Apply each re-ranker</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reranker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rerankers</span><span class="p">):</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="n">reranker</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;query&#39;</span> <span class="ow">in</span> <span class="n">reranker</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span> <span class="k">else</span> <span class="n">reranker</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">log_ranking</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rerank_step_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">docs</span>
</code></pre></div>

<p>In this code above:</p>
<ol>
<li>We define a simple <code>Document</code> class to represent our documents.</li>
<li>The <code>RankingTracker</code> class is responsible for logging rankings at each step and writing them to a file.</li>
<li>We have a basic <code>Retriever</code> class that simulates initial document retrieval.</li>
<li>Two re-ranking functions are defined: <code>cross_encoder_rerank</code> and <code>custom_rerank</code>. These simulate different re-ranking strategies.</li>
<li>The <code>rag_retrieval</code> function orchestrates the entire process:<ul>
<li>It first retrieves documents using the retriever.</li>
<li>Then it applies each re-ranker in sequence.</li>
<li><strong>After each step, it logs the current ranking using the tracker</strong>.</li>
</ul>
</li>
</ol>
<p>Here is the usage, with steps:</p>
<ul>
<li>Initialize the tracker and retriever.</li>
<li>Call <code>rag_retrieval</code> with the query, retriever, list of re-rankers, and tracker.</li>
<li>Print the final rankings.</li>
<li>Flush the tracked rankings to a file.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Usage</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">RankingTracker</span><span class="p">(</span><span class="s2">&quot;ranking_results.json&quot;</span><span class="p">)</span>
    <span class="n">retriever</span> <span class="o">=</span> <span class="n">Retriever</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is the capital of France?&quot;</span>

    <span class="n">final_docs</span> <span class="o">=</span> <span class="n">rag_retrieval</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">retriever</span><span class="p">,</span>
        <span class="p">[</span><span class="n">cross_encoder_rerank</span><span class="p">,</span> <span class="n">custom_rerank</span><span class="p">],</span>
        <span class="n">tracker</span>
    <span class="p">)</span>

    <span class="c1"># Print final rankings</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final document rankings:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">final_docs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, Score: </span><span class="si">{</span><span class="n">doc</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save all rankings to file</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</code></pre></div>

<p><a id="visualization"></a></p>
<h2>Visualization</h2>
<p>For the visualization part you can use small Python library <a href="https://pypi.org/project/rankflow/">rankflow</a> (disclaimer: I'm the author) that is able to produce this type of visualization:
<img alt="RankFlow Plot" src="/images/rankflow/rankflow_plot_full.jpg"></p>
<p>First, install it with pip:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>rankflow
</code></pre></div>

<p>It can accept various input data formats, one, convenient for data scientists is pandas data frame.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">rankflow</span> <span class="kn">import</span> <span class="n">RankFlow</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Doc 1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Doc 2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;Doc 3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Step_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_3&quot;</span><span class="p">,</span> <span class="s2">&quot;Step_4&quot;</span><span class="p">])</span>
</code></pre></div>

<p>When the DataFrame is ready, then it is time to create RankFlow object and callÂ <code>plot()</code>Â method.</p>
<div class="highlight"><pre><span></span><code><span class="n">rf</span> <span class="o">=</span> <span class="n">RankFlow</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># save the plot to png</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;rankflow.png&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p>If you found this library useful, please star the <a href="https://github.com/izikeros/rankflow">repo</a>.</p>
<p>With plotting options you have also some alternatives that you can use or take inspiration to create you own, customized rankflow plot/bump chart. See the references for alternatives.</p>
<p><a id="references"></a></p>
<h2>References</h2>
<ul>
<li><a href="https://www.vrogue.co/post/how-to-plot-bump-chart-in-r-finnstats">How To Plot Bump Chart In R Finnstats - vrogue.co</a></li>
<li><a href="https://github.com/kartikay-bagla/bump-plot-python">GitHub - kartikay-bagla/bump-plot-python</a></li>
<li><a href="https://mplsoccer.readthedocs.io/en/latest/gallery/bumpy_charts/plot_bumpy.html#sphx-glr-gallery-bumpy-charts-plot-bumpy-py">Bumpy Charts â mplsoccer 1.2.4 documentation</a></li>
<li><a href="https://nbviewer.org/gist/pascal-schetelat/8382651">Jupyter Notebook Viewer</a></li>
</ul>
        </div>




            <div class="bibtex-note">
                <p><b>To cite this article:</b></p>
                <pre>@article{Saf2024RankFlow,
    author  = {Krystian Safjan},
    title   = {RankFlow plot for retriever visual evaluation},
    journal = {Krystian's Safjan Blog},
    year    = {2024},
}</pre>
            </div>
        <div class="tag-cloud">
            <p>
                    <br/><br/>Tags:&nbsp;
                        <a href="https://www.safjan.com/tag/retriever/">retriever</a>
                        <a href="https://www.safjan.com/tag/rag/">rag</a>
                        <a href="https://www.safjan.com/tag/visuallization/">visuallization</a>
                        <a href="https://www.safjan.com/tag/rag-evaluation/">rag-evaluation</a>
                        <a href="https://www.safjan.com/tag/logging/">logging</a>
                        <a href="https://www.safjan.com/tag/struct-log/">struct-log</a>
                        <a href="https://www.safjan.com/tag/rankflow/">rankflow</a>
                        <a href="https://www.safjan.com/tag/observability/">observability</a>
                        <a href="https://www.safjan.com/tag/callback/">callback</a>
            </p>
        </div>








            <div class="related-posts">
                <h4>You might enjoy</h4>
                <ul class="related-posts">
                        <li><a href="https://www.safjan.com/rag-fusion-enhancing-information-retrieval-in-large-language-models/">RAG-Fusion - Enhancing Information Retrieval in Large Language Models</a></li>
                        <li><a href="https://www.safjan.com/techniques-to-boost-rag-performance-in-production/">Techniques to Boost RAG Performance in Production</a></li>
                        <li><a href="https://www.safjan.com/from-fixed-size-to-nlp-chunking-a-deep-dive-into-text-chunking-techniques/">From Fixed-Size to NLP Chunking - A Deep Dive into Text Chunking Techniques</a></li>
                        <li><a href="https://www.safjan.com/understanding-retrieval-augmented-generation-rag-empowering-llms/">Understanding Retrieval-Augmented Generation (RAG) empowering LLMs</a></li>
                        <li><a href="https://www.safjan.com/ragas-metrics-cheat-sheet/">RAGAS metrics cheat sheet</a></li>
                </ul>
            </div>

  <div class="neighbors">
  </div>


    </article>

    <footer>
<p>
  &copy; 2024 Krystian Safjan - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
</main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Krystian Safjan's Blog ",
  "url" : "https://www.safjan.com",
  "image": "/images/profile_new.jpg",
  "description": ""
}
</script>

</body>
</html>