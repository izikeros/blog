
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="color-scheme" content="light dark"/>
    <script>
      (function() {
        var theme = localStorage.getItem('theme-preference');
        if (theme === 'dark' || theme === 'light') {
          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"/>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap"
              rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/stylesheet/style.css">


    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/pygments/github.min.css">


    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/solid.css">

    <link rel="stylesheet" href="https://www.safjan.com/pagefind/pagefind-ui.css">

        <link rel="stylesheet" type="text/css"
              href="https://www.safjan.com/styles/custom.css">

        <link href="https://www.safjan.com/feeds/all.atom.xml?utm_source=rss&utm_medium=feed&utm_campaign=rss-feed" type="application/atom+xml" rel="alternate"
              title="Krystian Safjan's Blog Atom">

        <link href="https://www.safjan.com/feeds/all.rss.xml?utm_source=rss&utm_medium=feed&utm_campaign=rss-feed" type="application/rss+xml" rel="alternate"
              title="Krystian Safjan's Blog RSS">


    <link rel="apple-touch-icon" sizes="180x180" href="https://www.safjan.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.safjan.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.safjan.com/favicon-16x16.png">
    <link rel="shortcut icon" href="https://www.safjan.com/favicon.ico">
    <link rel="manifest" href="https://www.safjan.com/site.webmanifest">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-title" content="Krystian Safjan's Blog">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RM2PKDCCYM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RM2PKDCCYM');
</script>
<!-- End of Google tag (gtag.js) -->



    <meta name="author" content="Krystian Safjan"/>
    <meta name="description" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent."/>
    <meta name="keywords" content="trend, segmentation, algotrading">


  <meta property="og:site_name" content="Krystian Safjan's Blog"/>
  <meta property="og:title" content="Automated Signal Segmentation, Trend Detection, and Classification"/>
  <meta property="og:description" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.safjan.com/automated-trend-detection-and-signal-segmentation/"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-09-12 00:00:00+02:00"/>
  <meta property="article:modified_time" content="2023-07-12 00:00:00+02:00"/>
  <meta property="article:author" content="https://www.safjan.com/author/krystian-safjan/"/>
  <meta property="article:section" content="Howto"/>
  <meta property="article:tag" content="trend"/>
  <meta property="article:tag" content="segmentation"/>
  <meta property="article:tag" content="algotrading"/>
  <meta property="og:image" content="https://www.safjan.com/images/head/trend_detection_head.jpg"/>
  <meta property="og:image:width" content="1200"/>
  <meta property="og:image:height" content="630"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.safjan.com/images/head/trend_detection_head.jpg"/>
    <meta name="twitter:image:alt" content="Automated Signal Segmentation, Trend Detection, and Classification"/>


    <meta name="twitter:site" content="@izikeros"/>
    <meta name="twitter:creator" content="@izikeros"/>
    <meta name="twitter:title" content="Automated Signal Segmentation, Trend Detection, and Classification"/>
    <meta name="twitter:description" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent."/>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.safjan.com/automated-trend-detection-and-signal-segmentation/"
  },
  "headline": "Automated Signal Segmentation, Trend Detection, and Classification",
  "datePublished": "2022-09-12T00:00:00+02:00",
  "dateModified": "2023-07-12T00:00:00+02:00",
  "author": {
    "@type": "Person",
    "name": "Krystian Safjan",
    "url": "https://www.safjan.com/author/krystian-safjan/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Krystian Safjan's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/profile_new.jpg"
    }  },
"image": "https://www.safjan.com/images/head/trend_detection_head.jpg",  "url": "https://www.safjan.com/automated-trend-detection-and-signal-segmentation/",
  "description": "This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent.",
  "articleSection": "Howto",
  "inLanguage": "en",
  "keywords": "trend, segmentation, algotrading",
  "wordCount": 797,
  "speakable": {
    "@type": "SpeakableSpecification",
    "cssSelector": ["article h1", ".summary", ".tldr", "article \u003e p:first-of-type"]
  }}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://www.safjan.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Howto",
      "item": "https://www.safjan.com/category/howto.html"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Automated Signal Segmentation, Trend..."
    }
  ]
}
</script>



<meta name="ai:summary" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent.">

<meta name="ai:topics" content="trend, segmentation, algotrading">



<meta name="ai:word-count" content="797">
<meta name="ai:reading-time" content="3 min">

<meta name="ai:section" content="Howto">



<meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">

    <title>    Automated Signal Segmentation, Trend Detection, and Classification
</title>



<!-- Google Automatic Ads -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9767732578835199"
     crossorigin="anonymous"></script>
<!-- End of Google Automatic Ads -->


</head>
<body>
<div id="reading-progress" class="reading-progress"></div>
<aside>
    <div>
        <a href="https://www.safjan.com/">
                <img src="/images/profile_new.jpg" alt="Krystian Safjan's Blog" title="Krystian Safjan's Blog" width="140" height="140">
        </a>

        <h1>
            <a href="https://www.safjan.com/">Krystian Safjan's Blog</a>
        </h1>

<p>Data Scientist and Team Leader writing about Machine Learning, MLOps, and Python</p>


        <ul class="social">
                <li>
                    <a  class="sc-linkedin" href="https://pl.linkedin.com/in/krystiansafjan"
                       target="_blank">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/izikeros"
                       target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-envelope" href="mailto:ksafjan@gmail.com"
                       target="_blank">
                        <i class="fas fa-envelope"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-graduation-cap" href="https://scholar.google.pl/citations?user=UlNJgMoAAAAJ"
                       target="_blank">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-rss" href="/feeds/all.rss.xml"
                       target="_blank">
                        <i class="fas fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>

<div class="promo-box">
    <a href="https://ksafjanuser.gumroad.com/l/mlops" class="promo-box-image">
        <img src="/images/mlop_interview_book_cover_3D_300px.jpg" alt="MLOps Interview Book Cover">
    </a>
    
    <p class="promo-box-headline">Ace Your MLOps Interview</p>
    
    <a href="https://ksafjanuser.gumroad.com/l/mlops" class="promo-box-cta">
        Get for $2.99
    </a>
    
    <p class="promo-box-features">50 Q&A â€¢ PDF/ePUB/mobi</p>
</div>
</aside>
<main>

        <nav aria-label="Main navigation">
            <a href="https://www.safjan.com/">Home</a>

                <a href="/archives.html">Articles</a>
                <a href="/til.html">Notes</a>
                <a href="/categories.html">Categories</a>
                <a href="/pdfs/Krystian_Safjan_resume_priv.pdf">Resume</a>

                <a href="https://www.safjan.com/feeds/all.atom.xml">Atom</a>

                <a href="https://www.safjan.com/feeds/all.rss.xml">RSS</a>

            <div id="search" class="nav-search"></div>
            <button type="button" id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
            </button>
        </nav>

    <article class="single">
        <header>
                
            <p>
                <!-- Posted on: -->
                2022-09-12 


                <br/>
            </p>
            <h1>Automated Signal Segmentation, Trend Detection, and Classification</h1>
            <div class="header-underline"></div>
                <div class="summary"><p>This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent.</p></div>

                <div style="width: 100%; padding-bottom: 30px; position: relative;">
                    <a href="https://www.safjan.com/automated-trend-detection-and-signal-segmentation/">
                        <img style="width: 100%; "
                             src="images/head/trend_detection_head.jpg" alt="Automated Signal Segmentation, Trend Detection, and Classification">
                    </a>
                </div>


        </header>




        <div class="article-content">
            <h2 id="problem-statement">Problem statement</h2>
<ol>
<li>Partition time series into segments, where the signal in the segment has a consistent trend (e.g. up-trend, down-trend)</li>
<li>Characterise trend in the segment, e.g. provide coefficients of the equation describing the trend in the segment.</li>
</ol>
<h2 id="windowing-approach">Windowing Approach</h2>
<p>The discussed solution is based on the concept of analyzing signals using a sliding window with a fixed length. The consecutive windows can overlap.</p>
<p><img alt="trend lines within the window" src="/images/trend_segmentation/trend_in_windows.jpg">
<strong>Figure 1. Windowing approach for trend detection - trend line fit to datapoints in each overlapping window.</strong></p>
<p>For each window perform linear regression to find the line that best fits the signal. If the parameters of a linear regression between two windows do not differ too much, the signal covered by these two windows is considered as belonging to the same segment with a coherent trend.</p>
<h2 id="example">Example</h2>
<p>Let's say, we wanted to do segmentation of the time series on segments with similar trends. For that task, you can use <a href="https://pypi.org/project/trend-classifier/">trend-classifier</a> Python library. It is pip installable (<code>pip3 install trend-classifier</code>).</p>
<p>Here is an example that gets the time series data from YahooFinance and performs the analysis.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">trend_classifier</span> <span class="kn">import</span> <span class="n">Segmenter</span>

<span class="c1"># download the data from yahoo finance</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2018-09-15&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2022-09-05&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y_in</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">seg</span> <span class="o">=</span> <span class="n">Segmenter</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">seg</span><span class="o">.</span><span class="n">calculate_segments</span><span class="p">()</span>
</code></pre></div>

<p>Now, you can plot the time series with trend lines and segment boundaries with:</p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segments</span><span class="p">()</span>
</code></pre></div>

<p><img alt="segmentation example" src="/images/trend_segmentation/screenshoot_1.jpg">
<strong>Figure 2. Visualization of the signal segmentation based on the trend.</strong></p>
<p>You can inspect details about each segment (e.g. positive value for slope indicates an up-trend and a negative down-trend). To see info about the segment with index <code>3</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">devtools</span> <span class="kn">import</span> <span class="n">debug</span>
<span class="n">debug</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</code></pre></div>

<p>You can have information about all segments in tabular form using <code>Segmenter.segments.to_dataframe()</code> method which produces Pandas DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</code></pre></div>

<h2 id="controlling-generalization">Controlling generalization</h2>
<p>There is a parameter that controls the "generalization" factor, i.e. you can try to fit a trend line to a smaller range of time series - you will end up with a large number of segments, or you can go for the segments spanning a bigger part of the time series (more general trend line) and end up with a time series divided into fewer segments. To control that behavior, when initializing <code>Segmenter()</code> (e.g. <code>Segmenter(x_in, y_in, n=20)</code> use various values for <code>n</code> parameter. The larger <code>n</code> the generalization is stronger (fewer segments).</p>
<p><img alt="segmentation for n=20" src="../images/trend_segmentation/segments_n_20.jpg">
<strong>Figure 3. Signal segmentation with fine granularity (weak generalization), n=20.</strong></p>
<p><img alt="segmentation for n=80" src="/images/trend_segmentation/segments_n_80.jpg">
<strong>Figure 4. Signal segmentation with rough granularity (strong generalization), n=80.</strong></p>
<h2 id="an-exemplary-application-of-trend-detection-and-segmentation">An exemplary application of trend detection and segmentation</h2>
<p>This tool can be used to extract parts of the signal where the trend has given parameters. E.g. extract segments with:</p>
<ul>
<li>up-trend</li>
<li>down-trend</li>
<li>the signal is in a horizontal channel</li>
</ul>
<p>We can write a very basic classifier based on the slope parameter. If the slope is positive, or higher than the threshold value, consider this segment with an up-trend. There are also separate rules for down-trend and horizontal-trend types.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">segment_classifier</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">slope</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;up&quot;</span>
    <span class="k">elif</span> <span class="n">segment</span><span class="o">.</span><span class="n">slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">th</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;down&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;horiz&quot;</span>
</code></pre></div>

<p>Next, we can use this function to get indices of trends in a given type, and plot them.</p>
<div class="highlight"><pre><span></span><code><span class="n">up_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">]</span>
<span class="n">down_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">]</span>
<span class="n">horiz_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;horiz&quot;</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">up_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="up-trend" src="/images/trend_segmentation/uptrend.jpg">
<strong>Figure 5. Segments classified as "up-trend".</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">down_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="down-trend" src="/images/trend_segmentation/downtrend.jpg">
<strong>Figure 6. Segments classified as "down-trend".</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">horiz_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="horizontal-trend" src="/images/trend_segmentation/horiz_trend.jpg">
<strong>Figure 7. Segments classified as "horizontal-trend".</strong></p>
<p>The classification function used in the example was very simple and one can implement a more robust function e.g. one, that uses other than <code>slope</code> data stored in the segment object.</p>
<h2 id="summary">Summary</h2>
<p>This article describes the <a href="https://pypi.org/project/trend-classifier/">trend-classifier</a> library that is using the calculation of linear regression within the overlapping windows for signal segmentation. If the parameters of the regression for the following windows are similar, then the windows are considered as belonging to the same trend and the segment is extended by the newly analyzed window and the operation is continued for the next windows. When using this tool you need to know the limitations:</p>
<ul>
<li>there is a trade-off between the efficiency (best fit) and the generalization (number of segments) - the smaller window size (parameter <code>n</code> of the <code>Segmenter()</code>) the better fit but also more resulting segments and less generalization.</li>
<li>arbitrary (but configurable) threshold values are used to determine if the window is a continuation of the trend from the previous window or if it should be a new segment with a different trend)</li>
<li>since the criterion for starting a new segment is a "significant" difference between two consecutive windows, one can imagine that if the trend is changing slowly, with small changes e.g. uptrend can change to downtrend, and no trend change will be detected.</li>
</ul>
<p><em>Any comments or suggestions? <a href="mailto:ksafjan@gmail.com?subject=Blog+post">Let me know</a>.</em></p>
        </div>




            <div class="bibtex-note">
                <p><b>To cite this article:</b></p>
                <pre>@article{Saf2022Automated,
    author  = {Krystian Safjan},
    title   = {Automated Signal Segmentation, Trend Detection, and Classification},
    journal = {Krystian's Safjan Blog},
    year    = {2022},
}</pre>
            </div>
        <div class="article-tags">
            <span class="tags-label">Tags:</span>
                <a href="https://www.safjan.com/tag/trend/" class="article-tag">trend</a>
                <a href="https://www.safjan.com/tag/segmentation/" class="article-tag">segmentation</a>
                <a href="https://www.safjan.com/tag/algotrading/" class="article-tag">algotrading</a>
        </div>







            <div class="related-posts">
                <h4 class="related-posts-title">You might also like</h4>
                <div class="related-posts-grid">
                        <a href="https://www.safjan.com/lesser-known-backtesting-libraries/" class="related-post-card">
                            <span class="related-post-title">Lesser Known Backtesting Libraries</span>
                            <span class="related-post-date">Jun 05, 2022</span>
                        </a>
                </div>
            </div>




    </article>

    <footer>
<p>
  &copy; 2026 Krystian Safjan - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>    </footer>
</main>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": "Krystian Safjan's Blog",
  "url": "https://www.safjan.com",
"image": "/images/profile_new.jpg",  "description": ""
}
</script>


<script src="https://www.safjan.com/pagefind/pagefind-ui.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', function() {
        new PagefindUI({
            element: "#search",
            showSubResults: false,
            showImages: false,
            basePath: "https://www.safjan.com/pagefind/"
        });
    });
</script>

<script src="https://www.safjan.com/theme/js/theme-switcher.js"></script>

<style>
.youtube-embed {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    background: #000;
    border-radius: 0.375rem;
    overflow: hidden;
}
.youtube-embed iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
}
.youtube-embed-wrapper {
    margin-bottom: 1rem;
}
.youtube-embed-info {
    padding: 0.5rem 0.75rem;
    background: var(--color-bg-secondary, #f6f8fa);
    border-radius: 0 0 0.375rem 0.375rem;
    font-size: 0.875rem;
    margin-top: -0.375rem;
}
.youtube-embed-info a {
    text-decoration: none;
    color: inherit;
}
.youtube-embed-info a:hover {
    text-decoration: underline;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('pre > code').forEach(function(code) {
        var text = code.textContent.trim();
        if (!text.match(/^https?:\/\/(www\.)?(youtube\.com|youtu\.be)/)) return;

        var lines = text.split('\n');
        var url = lines[0].trim();
        var match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
        if (!match) return;
        var videoId = match[1];

        var meta = {};
        lines.slice(1).forEach(function(line) {
            var m = line.match(/^(\w+):\s*(.+)$/);
            if (m) meta[m[1].toLowerCase()] = m[2].trim();
        });

        var wrapper = document.createElement('div');
        wrapper.className = 'youtube-embed-wrapper';

        var embed = document.createElement('div');
        embed.className = 'youtube-embed';
        embed.innerHTML = '<iframe src="https://www.youtube-nocookie.com/embed/' + videoId +
            '" allowfullscreen loading="lazy" title="' + (meta.title || 'YouTube video').replace(/"/g, '&quot;') + '"></iframe>';
        wrapper.appendChild(embed);

        if (meta.title || meta.author) {
            var info = document.createElement('div');
            info.className = 'youtube-embed-info';
            var html = meta.title ? '<strong>' + meta.title + '</strong>' : '';
            if (meta.author) {
                html += (meta.title ? ' &bull; ' : '');
                html += meta.authorurl ? '<a href="' + meta.authorurl + '" target="_blank" rel="noopener">' + meta.author + '</a>' : meta.author;
            }
            info.innerHTML = html;
            wrapper.appendChild(info);
        }
        code.closest('pre').replaceWith(wrapper);
    });
});
</script>
</body>
</html>