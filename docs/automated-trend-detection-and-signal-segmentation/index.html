
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="HandheldFriendly" content="True"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"/>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap"
              rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/stylesheet/style.min.css">



        <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              href="https://www.safjan.com/theme/pygments/github.min.css">



    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/fontawesome.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/brands.css">
    <link rel="stylesheet" type="text/css" href="https://www.safjan.com/theme/font-awesome/css/solid.css">

        <link rel="stylesheet" type="text/css"
              href="https://www.safjan.com/styles/custom.css">

        <link href="https://www.safjan.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Krystian Safjan's Blog Atom">

        <link href="https://www.safjan.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Krystian Safjan's Blog RSS">


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RM2PKDCCYM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RM2PKDCCYM');
</script>
<!-- End of Google tag (gtag.js) -->



    <meta name="author" content="Krystian Safjan"/>
    <meta name="description" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent."/>
    <meta name="keywords" content="trend, segmentation, algotrading">
    <meta expr:content="2022-09-12 00:00:00+02:00" itemprop='datePublished'/>
    <meta expr:content="2022-09-12 00:00:00+02:00" itemprop='dateModified'/>
    <meta property="article:modified_time" content="2022-09-12 00:00:00+02:00"/>
    <meta property="article:published_time" content="2022-09-12 00:00:00+02:00"/>
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Automated signal segmentation, trend detection, and classification",
  "datePublished": "2022-09-12 00:00:00+02:00",
  "dateModified": "2022-09-12 00:00:00+02:00"
}








    </script>



  <meta property="og:site_name" content="Krystian Safjan's Blog"/>
  <meta property="og:title" content="Automated signal segmentation, trend detection, and classification"/>
  <meta property="og:description" content="This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://www.safjan.com/automated-trend-detection-and-signal-segmentation/"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-09-12 00:00:00+02:00"/>
  <meta property="article:modified_time" content="2022-09-12 00:00:00+02:00"/>
  <meta property="article:author" content="https://www.safjan.com/author/krystian-safjan/">
  <meta property="article:section" content="Howto"/>
  <meta property="article:tag" content="trend"/>
  <meta property="article:tag" content="segmentation"/>
  <meta property="article:tag" content="algotrading"/>
  <meta property="og:image" content="https://www.safjan.com/images/head/trend_detection_head.jpg">

    <meta name="twitter:card" content="summary"/>
    <meta property="twitter:image" content="https://www.safjan.com/images/head/trend_detection_head.jpg">

    <meta name="twitter:label1" content="Est. reading time"/>
    <meta name="twitter:data1" content="4 min."/>
    <meta name="twitter:site" content="@izikeros"/>
    <meta name="twitter:description" content="<p>This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent.</p>"/>
    <meta name="twitter:title" content="Automated signal segmentation, trend detection, and classification"/>


    <title>    Automated signal segmentation, trend detection, and classification
</title>


<!-- Google Automatic Ads -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9767732578835199"
     crossorigin="anonymous"></script>
<!-- End of Google Automatic Ads -->


</head>
<body class="light-theme">
<aside>
    <div>
        <a href="https://www.safjan.com/">
                <img src="/images/profile_new.jpg" alt="Krystian Safjan's Blog" title="Krystian Safjan's Blog" width="140" height="140">
        </a>

        <h1>
            <a href="https://www.safjan.com/">Krystian Safjan's Blog</a>
        </h1>

<p>Data Scientist | Researcher | Team Leader<br><br> working at Ernst &amp; Young and writing about <a href="/category/machine-learning.html">Data Science and Visualization</a>, on <a href="/category/machine-learning.html">Machine Learning, Deep Learning</a> and <a href="/tag/nlp/">NLP</a>. There are also some  <a href="/category/howto.html">howto</a> posts on tools and workflows.</p>




        <ul class="social">
                <li>
                    <a  class="sc-linkedin" href="https://pl.linkedin.com/in/krystiansafjan"
                       target="_blank">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-github" href="https://github.com/izikeros"
                       target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-envelope" href="mailto:ksafjan@gmail.com"
                       target="_blank">
                        <i class="fas fa-envelope"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-graduation-cap" href="https://scholar.google.pl/citations?user=UlNJgMoAAAAJ"
                       target="_blank">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </li>
                <li>
                    <a  class="sc-rss" href="/feeds/all.rss.xml"
                       target="_blank">
                        <i class="fas fa-rss"></i>
                    </a>
                </li>
        </ul>
    </div>

<style>
    .button {
        background-color: yellow;
        color: black;
        border: none;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 20px;
    }

    .center {
        text-align: center;
    }

    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }

    .left-col {
    }

    .right-col {
    }

    .image {
        border-radius: 0;
        width: 100%;
    }

    .book-list {
        padding-top:0;
        padding-bottom: 0;
        text-align:left;
        box-sizing: border-box;
        display: block;
        list-style-image: url(/images/shortcode-tick.webp);
        margin-block-start: 1em;
        margin-block-end: 1em;
        margin-inline-start:0;
        margin-inline-end:0;
        padding-inline-start:40px;
    }

    .book-list li {
        font-weight: bold;
    }

    @media (max-width: 600px) {
        .container {
            grid-template-columns: 1fr;
        }
    }

</style>
<div class="container">
    <div class="left-col">
        <a href="https://ksafjanuser.gumroad.com/l/mlops">
            <img src="/images/mlop_interview_book_cover_3D_300px.jpg" class="image" alt="Interview Book Cover">
        </a>

        <div class="center">
            <a href="https://ksafjanuser.gumroad.com/l/mlops">
                <button class="button">Get for $2.99</button>
            </a>
        </div>
    </div>
    <div class="right-col">
        <div>
            <ul class="book-list">
                <li>PDF, ePUB, mobi format ebook, no DRM</li>
                <li>50 questions and answers</li>
                <li>Stories from real projects</li>
                <li>92 multiple choice quiz questions</li>
                <li>80 pages</li>
            </ul>
        </div>
    </div>
</div>
</aside>
<main>

        <nav>
            <a href="https://www.safjan.com/">Home</a>

                <a href="/archives.html">Articles</a>
                <a href="/til.html">Notes</a>
                <a href="/categories.html">Categories</a>
                <a href="/tags.html">Tags</a>
                <a href="/pdfs/Krystian_Safjan_resume_priv.pdf">Resume</a>

                <a href="https://www.safjan.com/feeds/all.atom.xml">Atom</a>

                <a href="https://www.safjan.com/feeds/all.rss.xml">RSS</a>
        </nav>

    <article class="single">
        <header>
                
            <p>
                <!-- Posted on: -->
                2022-09-12 



                    <span id="post-share-links">
    &nbsp;&nbsp;&nbsp;Share on:
    <a href="https://twitter.com/intent/tweet?text=Automated%20signal%20segmentation%2C%20trend%20detection%2C%20and%20classification&url=https%3A//www.safjan.com/automated-trend-detection-and-signal-segmentation/&hashtags=trend,segmentation,algotrading" target="_blank" title="Share on Twitter">Twitter</a>
    |
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//www.safjan.com/automated-trend-detection-and-signal-segmentation/" target="_blank" title="Share on Facebook">Facebook</a>
    |
    <a href="https://news.ycombinator.com/submitlink?t=Automated%20signal%20segmentation%2C%20trend%20detection%2C%20and%20classification&u=https%3A//www.safjan.com/automated-trend-detection-and-signal-segmentation/" target="_blank" title="Share on HackerNews">HackerNews</a>
    |
    <a href="https://www.reddit.com/submit?url=https%3A//www.safjan.com/automated-trend-detection-and-signal-segmentation/&title=Automated%20signal%20segmentation%2C%20trend%20detection%2C%20and%20classification" target="_blank" title="Share via Reddit">Reddit</a>
  </span>
                <br/>
            </p>
            <h1 id="automated-trend-detection-and-signal-segmentation">Automated signal segmentation, trend detection, and classification</h1>
            <div class="header-underline"></div>
                <p class="summary"><p>This post presents the trend-classifier package that can be used for signal segmentation into parts where the trend is coherent.</p></p>

                <div style="width: 100%; padding-bottom: 30px; position: relative;">
                    <a href="https://www.safjan.com/automated-trend-detection-and-signal-segmentation/">
                        <img style="width: 100%; "
                             src="images/head/trend_detection_head.jpg" alt="">
                    </a>
                </div>


        </header>


        <div>
            <h2>Problem statement</h2>
<ol>
<li>Partition time series into segments, where the signal in the segment has a consistent trend (e.g. up-trend, down-trend)</li>
<li>Characterise trend in the segment, e.g. provide coefficients of the equation describing the trend in the segment.</li>
</ol>
<h2>Windowing Approach</h2>
<p>The discussed solution is based on the concept of analyzing signals using a sliding window with a fixed length. The consecutive windows can overlap.</p>
<p><img alt="trend lines within the window" src="/images/trend_segmentation/trend_in_windows.jpg">
<strong>Figure 1. Windowing approach for trend detection - trend line fit to datapoints in each overlapping window.</strong></p>
<p>For each window perform linear regression to find the line that best fits the signal. If the parameters of a linear regression between two windows do not differ too much, the signal covered by these two windows is considered as belonging to the same segment with a coherent trend.</p>
<h2>Example</h2>
<p>Let's say, we wanted to do segmentation of the time series on segments with similar trends. For that task, you can use <a href="https://pypi.org/project/trend-classifier/">trend-classifier</a> Python library. It is pip installable (<code>pip3 install trend-classifier</code>).</p>
<p>Here is an example that gets the time series data from YahooFinance and performs the analysis.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">trend_classifier</span> <span class="kn">import</span> <span class="n">Segmenter</span>

<span class="c1"># download the data from yahoo finance</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2018-09-15&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;2022-09-05&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x_in</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y_in</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">seg</span> <span class="o">=</span> <span class="n">Segmenter</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">seg</span><span class="o">.</span><span class="n">calculate_segments</span><span class="p">()</span>
</code></pre></div>

<p>Now, you can plot the time series with trend lines and segment boundaries with:</p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segments</span><span class="p">()</span>
</code></pre></div>

<p><img alt="segmentation example" src="/images/trend_segmentation/screenshoot_1.jpg">
<strong>Figure 2. Visualization of the signal segmentation based on the trend.</strong></p>
<p>You can inspect details about each segment (e.g. positive value for slope indicates an up-trend and a negative down-trend). To see info about the segment with index <code>3</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">devtools</span> <span class="kn">import</span> <span class="n">debug</span>
<span class="n">debug</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</code></pre></div>

<p>You can have information about all segments in tabular form using <code>Segmenter.segments.to_dataframe()</code> method which produces Pandas DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</code></pre></div>

<h2>Controlling generalization</h2>
<p>There is a parameter that controls the "generalization" factor, i.e. you can try to fit a trend line to a smaller range of time series - you will end up with a large number of segments, or you can go for the segments spanning a bigger part of the time series (more general trend line) and end up with a time series divided into fewer segments. To control that behavior, when initializing <code>Segmenter()</code> (e.g. <code>Segmenter(x_in, y_in, n=20)</code> use various values for <code>n</code> parameter. The larger <code>n</code> the generalization is stronger (fewer segments).</p>
<p><img alt="segmentation for n=20" src="../images/trend_segmentation/segments_n_20.jpg">
<strong>Figure 3. Signal segmentation with fine granularity (weak generalization), n=20.</strong></p>
<p><img alt="segmentation for n=80" src="/images/trend_segmentation/segments_n_80.jpg">
<strong>Figure 4. Signal segmentation with rough granularity (strong generalization), n=80.</strong></p>
<h2>An exemplary application of trend detection and segmentation</h2>
<p>This tool can be used to extract parts of the signal where the trend has given parameters. E.g. extract segments with:
- up-trend
- down-trend
- the signal is in a horizontal channel</p>
<p>We can write a very basic classifier based on the slope parameter. If the slope is positive, or higher than the threshold value, consider this segment with an up-trend. There are also separate rules for down-trend and horizontal-trend types.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">segment_classifier</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">segment</span><span class="o">.</span><span class="n">slope</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;up&quot;</span>
    <span class="k">elif</span> <span class="n">segment</span><span class="o">.</span><span class="n">slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">th</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;down&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;horiz&quot;</span>
</code></pre></div>

<p>Next, we can use this function to get indices of trends in a given type, and plot them.</p>
<div class="highlight"><pre><span></span><code><span class="n">up_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">]</span>
<span class="n">down_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">]</span>
<span class="n">horiz_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">segments</span> <span class="k">if</span> <span class="n">segment_classifier</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;horiz&quot;</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">up_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="up-trend" src="/images/trend_segmentation/uptrend.jpg">
<strong>Figure 5. Segments classified as "up-trend".</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">down_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="down-trend" src="/images/trend_segmentation/downtrend.jpg">
<strong>Figure 6. Segments classified as "down-trend".</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">seg</span><span class="o">.</span><span class="n">plot_segment</span><span class="p">(</span><span class="n">horiz_idx</span><span class="p">)</span>
</code></pre></div>

<p><img alt="horizontal-trend" src="/images/trend_segmentation/horiz_trend.jpg">
<strong>Figure 7. Segments classified as "horizontal-trend".</strong></p>
<p>The classification function used in the example was very simple and one can implement a more robust function e.g. one, that uses other than <code>slope</code> data stored in the segment object.</p>
<h2>Summary</h2>
<p>This article describes the <a href="https://pypi.org/project/trend-classifier/">trend-classifier</a> library that is using the calculation of linear regression within the overlapping windows for signal segmentation. If the parameters of the regression for the following windows are similar, then the windows are considered as belonging to the same trend and the segment is extended by the newly analyzed window and the operation is continued for the next windows. When using this tool you need to know the limitations:
- there is a trade-off between the efficiency (best fit) and the generalization (number of segments) - the smaller window size (parameter <code>n</code> of the <code>Segmenter()</code>) the better fit but also more resulting segments and less generalization.
- arbitrary (but configurable) threshold values are used to determine if the window is a continuation of the trend from the previous window or if it should be a new segment with a different trend)
- since the criterion for starting a new segment is a "significant" difference between two consecutive windows, one can imagine that if the trend is changing slowly, with small changes e.g. uptrend can change to downtrend, and no trend change will be detected.</p>
<p><em>Any comments or suggestions? <a href="mailto:ksafjan@gmail.com?subject=Blog+post">Let me know</a>.</em></p>
        </div>




            <div class="bibtex-note">
                <p><b>To cite this article:</b></p>
                <pre>@article{Saf2022Automated,
    author  = {Krystian Safjan},
    title   = {Automated signal segmentation, trend detection, and classification},
    journal = {Krystian's Safjan Blog},
    year    = {2022},
}</pre>
            </div>
        <div class="tag-cloud">
            <p>
                    <br/><br/>Tags:&nbsp;
                        <a href="https://www.safjan.com/tag/trend/">trend</a>
                        <a href="https://www.safjan.com/tag/segmentation/">segmentation</a>
                        <a href="https://www.safjan.com/tag/algotrading/">algotrading</a>
            </p>
        </div>








            <div class="related-posts">
                <h4>You might enjoy</h4>
                <ul class="related-posts">
                        <li><a href="https://www.safjan.com/lesser-known-backtesting-libraries/">Lesser Known Backtesting Libraries</a></li>
                </ul>
            </div>

  <div class="neighbors">
    <a class="btn float-left" href="https://www.safjan.com/write-a-syslog-entry-from-a-bash-script/" title="Write a syslog entry from a bash script">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://www.safjan.com/lesser-known-yet-powerful-python-plotting-libraries/" title="10 Lesser-known, Yet Powerful Python Plotting Libraries">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>


    </article>

    <footer>
<p>
  &copy; 2023 Krystian Safjan - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
</main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Krystian Safjan's Blog ",
  "url" : "https://www.safjan.com",
  "image": "/images/profile_new.jpg",
  "description": ""
}
</script>

</body>
</html>